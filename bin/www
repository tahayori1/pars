#!/usr/bin/env node

var mar = [];
var menu = {
    title: 'Ù…ÙˆØ³Ø³Ù‡ Ø²Ø¨Ø§Ù† Ù¾Ø§Ø±Ø³Ø§',
    desc: 'Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒ ØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…ÙˆØ³Ø³Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯',
    text: 'Ø¨Ù‡ Ø±Ø¨Ø§Øª Ù…ÙˆØ³Ø³Ù‡ Ø²Ø¨Ø§Ù† Ù¾Ø§Ø±Ø³Ø§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ Ø¯Ø± Ú©Ø¯Ø§Ù… ÛŒÚ© Ø§Ø² Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ù…ÛŒØªÙˆØ§Ù†Ù… Ú©Ù…Ú© Ú©Ù†Ù…ØŸ',
    photo: '',
    time: 'Ø§Ù„Ø§Ù†',
    type: 'select',
    items: {
        'Ù…Ø¹Ø±ÙÛŒ Ù…ÙˆØ³Ø³Ù‡': {
            type: 'select',
            text: 'Ø¯Ø± Ø³Ø§Ù„ 1380 Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ Ø¯Ø± Ø´Ù‡Ø± Ø´ÛŒØ±Ø§Ø²  ØªØ§Ø³ÛŒØ³ Ø´Ø¯',
            items: {
                'Ø¢Ø´Ù†Ø§ÛŒÛŒ Ø¨Ø§ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ù‡Ø§': {
                    type: 'select',
                    text: 'Ù…ÙˆØ³Ø³Ù‡ Ø²Ø¨Ø§Ù† Ù¾Ø§Ø±Ø³Ø§ Ø§Ø² Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ù‡Ø§ÛŒ ØªØ®ØµØµÛŒ Ø¨Ù‡ Ø´Ø±Ø­ Ø²ÛŒØ± ØªØ´Ú©ÛŒÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.',
                    items: {
                        'Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ': {
                            type: 'select',
                            text: 'Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø¯Ø± Ø³Ø§Ù„ 1380 Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ Ø¯Ø± Ø´Ù‡Ø± Ø´ÛŒØ±Ø§Ø²  ØªØ§Ø³ÛŒØ³ Ø´Ø¯',
                            items: {
                                'Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ': {
                                    type: 'text',
                                    text: 'Ø¯Ø± Ø³Ø§Ù„ 1380 Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ Ø¯Ø± Ø´Ù‡Ø± Ø´ÛŒØ±Ø§Ø²  ØªØ§Ø³ÛŒØ³ Ø´Ø¯'
                                },
                            }
                        },
                        'Ø¹Ø±Ø¨ÛŒ': {
                            type: 'text',
                            text: 'Ø¯Ø± Ø³Ø§Ù„ 1380 Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ Ø¯Ø± Ø´Ù‡Ø± Ø´ÛŒØ±Ø§Ø²  ØªØ§Ø³ÛŒØ³ Ø´Ø¯'
                        },
                        'Ø¢Ù„Ù…Ø§Ù†ÛŒ': {
                            type: 'select',
                            text: 'Ø¯Ø± Ø³Ø§Ù„ 1380 Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ Ø¯Ø± Ø´Ù‡Ø± Ø´ÛŒØ±Ø§Ø²  ØªØ§Ø³ÛŒØ³ Ø´Ø¯',
                            items: {}
                        },
                        'ÙØ±Ø§Ù†Ø³Ù‡': {
                            type: 'text',
                            text: 'Ø¯Ø± Ø³Ø§Ù„ 1380 Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ Ø¯Ø± Ø´Ù‡Ø± Ø´ÛŒØ±Ø§Ø²  ØªØ§Ø³ÛŒØ³ Ø´Ø¯'
                        },
                        'ØªØ±Ú©ÛŒ': {
                            type: 'text',
                            text: 'Ø¯Ø± Ø³Ø§Ù„ 1380 Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ Ø¯Ø± Ø´Ù‡Ø± Ø´ÛŒØ±Ø§Ø²  ØªØ§Ø³ÛŒØ³ Ø´Ø¯'
                        },
                        'Ú†ÛŒÙ†ÛŒ': {
                            type: 'text',
                            text: 'Ø¯Ø± Ø³Ø§Ù„ 1380 Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ Ø¯Ø± Ø´Ù‡Ø± Ø´ÛŒØ±Ø§Ø²  ØªØ§Ø³ÛŒØ³ Ø´Ø¯'
                        }
                    }
                },
                'Ø¯ÙˆØ±Ù‡ Ù‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ Ø¢Ù†Ù„Ø§ÛŒÙ†': {
                    type: 'text',
                    text: 'Ø¯Ø± Ø³Ø§Ù„ 1380 Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ Ø¯Ø± Ø´Ù‡Ø± Ø´ÛŒØ±Ø§Ø²  ØªØ§Ø³ÛŒØ³ Ø´Ø¯'
                },
                'Ø´Ø±Ø§ÛŒØ· Ø«Ø¨Øª Ù†Ø§Ù…': {
                    type: 'text',
                    text: 'Ø¯Ø± Ø³Ø§Ù„ 1380 Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ Ø¯Ø± Ø´Ù‡Ø± Ø´ÛŒØ±Ø§Ø²  ØªØ§Ø³ÛŒØ³ Ø´Ø¯'
                },
                'Ø´Ù‡Ø±ÛŒÙ‡ Ø¯ÙˆØ±Ù‡ Ù‡Ø§': {
                    type: 'select',
                    text: 'Ù…ØªÙ‚Ø§Ø¶ÛŒ Ú©Ø¯Ø§Ù… Ù†ÙˆØ¹ Ø§Ø² Ø¯ÙˆØ±Ù‡ Ù‡Ø§ Ù‡Ø³ØªÛŒØ¯ØŸ',
                    items: {
                        'ØªØ±Ù…ÛŒÚ©': {
                            type: 'select', 
                                text:' ÙØ´Ø±Ø¯Ù‡ ÛŒØ§ Ù…Ø¹Ù…ÙˆÙ„ÛŒ' , 
                                items:{
                                    'ÙØ´Ø±Ø¯Ù‡':{},
                                 'Ù…Ø¹Ù…ÙˆÙ„ÛŒ':{},
                                }
                            },
                        'Ø®ØµÙˆØµÛŒ': {}
                    },
                },
            }
        },
        'Ø«Ø¨Øª Ù†Ø§Ù…': {
            title: 'Ø«Ø¨Øª Ù†Ø§Ù…',
            type: 'input',
            text: 'Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù…  Ø¯Ø± Ù…ÙˆØ³Ø³Ù‡ Ø²Ø¨Ø§Ù† Ù¾Ø§Ø±Ø³Ø§ ÙØ±Ù… Ø²ÛŒØ± Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ ÙØ±Ù…Ø§ÛŒÛŒØ¯',
            items: [{
                    name: 'Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ',
                    type: 'text',
                    len: 0,
                    desc: ''
},
                {
                    name: 'Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³',
                    type: 'tel',
                    len: 13,
                    desc: 'Ø¨Ù‡ Ù‡Ù…Ø±Ø§Ù‡ Ú©Ø¯ Ú©Ø´ÙˆØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø«Ø§Ù„: +989013443574'
},
                {
                    name: 'Ø´Ù…Ø§Ø±Ù‡ Ù…Ù„ÛŒ',
                    type: 'number',
                    len: 10,
                    desc: ''
},
                {
                    name: 'Ø²Ø¨Ø§Ù† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±',
                    type: 'select',
                    items: ['Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ', 'Ø¹Ø±Ø¨ÛŒ', 'ÙØ±Ø§Ù†Ø³Ù‡', 'ØªØ±Ú©ÛŒ', 'Ø¢Ù„Ù…Ø§Ù†ÛŒ', 'Ø§Ø³Ù¾Ø§Ù†ÛŒØ§ÛŒÛŒ', 'Ú†ÛŒÙ†ÛŒ', 'Ú©Ø±Ù‡ Ø§ÛŒ', 'Ú˜Ø§Ù¾Ù†ÛŒ', 'Ø±ÙˆØ³ÛŒ'],
                    len: 0,
                    desc: ''
}]

        },
        'Ø§Ù…ÙˆØ± Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ': {
            title: 'Ø§Ù…ÙˆØ± Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ',
            desc: 'Ø§Ø³ØªØ¹Ù„Ø§Ù… Ú©Ø§Ø±Ù†Ø§Ù…Ù‡ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¬Ø²ÙˆØ§Øª Ùˆ Ú©Ù„Ø§Ø³Ù‡Ø§ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¯Ø± Ø§ÛŒÙ† Ù‚Ø³Ù…Øª Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯.',
            photo: '',
            time: 'Ø§Ù„Ø§Ù†',
            type: 'input',
            text: 'Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø§Ù…ÙˆØ± Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ Ù…ÙˆØ³Ø³Ù‡ Ø²Ø¨Ø§Ù† Ù¾Ø§Ø±Ø³Ø§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø®Ø¯Ù…Ø§Øª Ù„Ø§Ø²Ù… Ø§Ø³Øª  Ú©Ø¯ Ù…Ù„ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ù†Ù…Ø§ÛŒÛŒØ¯.',
            items: [{
                    name: 'Ø´Ù…Ø§Ø±Ù‡ Ù…Ù„ÛŒ',
                    type: 'text',
                    len: 0,
                    desc: 'Ú©Ø¯ Ù…Ù„ÛŒ Ø¯Ù‡ Ø±Ù‚Ù…ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'
},
                {
                    name: 'Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„',
                    type: 'text',
                    len: 0,
                    desc: 'Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø±Ø§ Ø¨Ù‡ Ù‡Ù…Ø±Ø§Ù‡ ØµÙØ± Ø¢ØºØ§Ø²ÛŒÙ† Ùˆ Ø¨Ø¯ÙˆÙ† +98 ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ù…Ø«Ø§Ù„:09100000000 '
}]


        }
    },
};

var clients_list = {};
/**
 * Module dependencies.
 */

var app = require('../app');
var debug = require('debug')('parsa:server');
var http = require('http');
var https = require('https');
var fs = require('fs');
fs.readFile('./reportcard.txt', 'utf-8', function read(err, data) {
    if (err) {
        throw err;
    }
    content = data;

    // Invoke the next step here however you like

    processFile(content); // Or put the next step in a function and invoke it
});
var classes = [];
var students = {}
var reports = {}

function processFile(content) {

    content = content.split('\n');
    i = -1;
    content.forEach((x) => {

        x = x.split(',');
        if (x[0][0] == '@' || x[0][1] == '@') {
            var classDesc = {};
            classDesc.language = x[0].replace('@', '');
            classDesc.level = x[2];
            classDesc.teacher = x[1];
            classDesc.date = x[3];
            classes.push(classDesc);
            i++;

        } else if (x[0][0] == '#') {

            var student = {};
            student.id = x[0].replace('#', '');
            student.tel = x[6];
            student.name = x[7];
            students[x[0].replace('#', '')] = student;
            var report = {};
            report.absence = x[1];
            report.ca = x[2];
            report.mt = x[3];
            report.final = x[4];
            report.total = x[5];
            report.cl = (i == -1) ? classes[0] : classes[i];
            reports[x[0].replace('#', '')] = report;
            //reports.push(report);

        }

    })
    /* console.log(students['2281457769'], reports['2281457769']);*/

}

/**
 * Get port from environment and store in Express.
 */

var port = normalizePort(process.env.PORT || '8080');
app.set('port', port);

/**
 * Create HTTP server.
 */

var server = http.createServer(app);
var io = require('socket.io')(server);

io.on('connection', function (socket) {

    function responser(room, data) {
        var now = new Date();
        var str = {
            date: now.getTime(),
            message: data,
            room: room
        }
        io.to(`${socket.id}`).emit(room, JSON.stringify(str));
        return false;
    }

    function reciever(msg) {
        msg = JSON.parse(msg);
        console.log(address + ',' + socket.id + ' @ ' + new Date(msg.date));
        return msg.message;
    }
    var address = socket.handshake.address;
    var userAddress = address + ',' + socket.id;
    console.log(address + ',' + socket.id + ' Is Conected');

    function reportCard(x, y) {
        x = x.toEnglishDigit();
        y = y.toEnglishDigit();
        var str = ''
        if (students[x] && students[x].tel == y) {
            var result = ''
            var total = parseFloat(reports[x].ca) + parseFloat(reports[x].mt) + parseFloat(parseFloat(reports[x].final));
            var total = parseFloat(reports[x].total);
            if (total > 69) {
                result = 'ØªØ¨Ø±ÛŒÚ© ğŸ˜ğŸ‘ Ø´Ù…Ø§ Ø§ÛŒÙ† Ø¯ÙˆØ±Ù‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø±Ø§ Ù‚Ø¨ÙˆÙ„ Ø´Ø¯ÛŒØ¯.';
            } else {
                result = 'Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† Ø¯ÙˆØ±Ù‡ Ø±Ø§ ØªÚ©Ø±Ø§Ø± Ú©Ù†ÛŒØ¯ ğŸ˜¢';
            }
            if (true /*students[x] != undefined && reports[x].cl != undefined*/ ) {
                console.log(reports[x]);
                str += 'Ø³Ù„Ø§Ù… <br/>'
                str += students[x].name //name
                str += ' Ø¹Ø²ÛŒØ²<br/>' + result;
                str += '<br/>'
                str += 'Ù†ØªØ§ÛŒØ¬ Ú©Ù„Ø§Ø³ '
                if (reports[x].cl != undefined) {
                    str += reports[x].cl.language //Language
                    str += ' Ø³Ø·Ø­ '
                    str += reports[x].cl.level //Level
                    str += ' Ø¨Ø§ Ø§Ø³ØªØ§Ø¯ '
                    str += reports[x].cl.teacher //Master
                    str += '<br/>'
                }
                str += 'Ø¨Ù‡ Ø´Ø±Ø­ Ø²ÛŒØ± Ù…ÛŒ Ø¨Ø§Ø´Ø¯:'
                str += '<br/>'
                str += 'ØªØ¹Ø¯Ø§Ø¯ ØºÛŒØ¨Øª:'
                str += reports[x].absence //Absence
                str += '<br/>'
                str += 'ÙØ¹Ø§Ù„ÛŒØª Ú©Ù„Ø§Ø³ÛŒ:'
                str += reports[x].ca //Class Activity
                str += '<br/>'
                str += 'Ù…ÛŒØ§Ù† ØªØ±Ù…:'
                str += reports[x].mt //MidTerm
                str += '<br/>'
                str += 'Ù¾Ø§ÛŒØ§Ù† ØªØ±Ù…:'
                str += reports[x].final //Final
                str += '<br/>'
                str += '<b>Ù†Ù…Ø±Ù‡ Ú©Ù„:'
                str += reports[x].total;
                str += '</b><br/>'
                str += 'Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø´Ù…Ø§ Ø¯Ø± Ø³ÛŒØ³ØªÙ…:'
                str += students[x].tel //Tel
            } else {
                str += 'Ø®Ø·Ø§ Ø¯Ø± Ù†ØªØ§ÛŒØ¬';

            }

        } else {
            str = 'Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯',
                JSON.stringify(students[x]);
        }

        return str;
    }
    socket.on('chat', function (msg) {
        msg = reciever(msg);
        msg = msg.split(',');
        if (msg[0] == '#reg') {
            msg.shift() //reg
            msg.shift() //ÙØ´Ø±ÙˆØ¹
            var MenuName = msg.shift(); //menu name
            msg = JSON.parse(msg);
            if (MenuName == 'Ø§Ù…ÙˆØ± Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ') {
                var x = reportCard(msg['Ø´Ù…Ø§Ø±Ù‡ Ù…Ù„ÛŒ'], msg['Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„']);
                responser('chat', x);
            } else if (MenuName == 'Ø«Ø¨Øª Ù†Ø§Ù…') {
                responser('chat', 'Ø«Ø¨Øª Ù†Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯')
            }
        } else {
            parserObj(1, msg, menu);
        }

        function parserObj(i, arr, itm) {
            if (itm) {
                var myTitle = arr[i];

                if (itm.items && itm.items[myTitle]) {
                    parserObj(++i, arr, itm.items[myTitle]);
                } else if (itm[myTitle]) {
                    responser('chat', itm[myTitle]);
                } else if (itm.text) {
                    responser('chat', itm);
                } else {
                    responser('chat', itm);
                }
            } else {
                responser('chat', 'Ù¾Ø§Ø³Ø®ÛŒ Ù†Ø¯Ø§Ø±ÛŒÙ…')
            }
        }

        return false;
    });
});
String.prototype.toEnglishDigit = function () {
    var find = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
    var replace = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
    var replaceString = this;
    var regex;
    for (var i = 0; i < find.length; i++) {
        regex = new RegExp(find[i], "g");
        replaceString = replaceString.replace(regex, replace[i]);
    }
    return replaceString;
};
/**
 * Listen on provided port, on all network interfaces.
 */

server.listen(port);
server.on('error', onError);
server.on('listening', onListening);

/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
    var port = parseInt(val, 10);

    if (isNaN(port)) {
        // named pipe
        return val;
    }

    if (port >= 0) {
        // port number
        return port;
    }

    return false;
}

/**
 * Event listener for HTTP server "error" event.
 */

function onError(error) {
    if (error.syscall !== 'listen') {
        throw error;
    }

    var bind = typeof port === 'string' ?
        'Pipe ' + port :
        'Port ' + port;

    // handle specific listen errors with friendly messages
    switch (error.code) {
        case 'EACCES':
            console.error(bind + ' requires elevated privileges');
            process.exit(1);
            break;
        case 'EADDRINUSE':
            console.error(bind + ' is already in use');
            process.exit(1);
            break;
        default:
            throw error;
    }
}

/**
 * Event listener for HTTP server "listening" event.
 */

function onListening() {
    var addr = server.address();
    var bind = typeof addr === 'string' ?
        'pipe ' + addr :
        'port ' + addr.port;
    debug('Listening on ' + bind);
}
